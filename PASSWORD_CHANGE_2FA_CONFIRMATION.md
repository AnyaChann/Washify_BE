# T√≠nh nƒÉng: X√°c nh·∫≠n qua Email khi B·∫≠t/T·∫Øt B·∫£o m·∫≠t 2 l·ªõp

## üìã T·ªïng quan
T√≠nh nƒÉng n√†y y√™u c·∫ßu x√°c nh·∫≠n qua email tr∆∞·ªõc khi b·∫≠t ho·∫∑c t·∫Øt b·∫£o m·∫≠t 2 l·ªõp cho vi·ªác ƒë·ªïi m·∫≠t kh·∫©u. ƒêi·ªÅu n√†y tƒÉng c∆∞·ªùng b·∫£o m·∫≠t b·∫±ng c√°ch ƒë·∫£m b·∫£o ch·ªâ ch·ªß s·ªü h·ªØu t√†i kho·∫£n th·ª±c s·ª± m·ªõi c√≥ th·ªÉ thay ƒë·ªïi c√†i ƒë·∫∑t quan tr·ªçng n√†y.

## üîê Lu·ªìng ho·∫°t ƒë·ªông

### Khi ng∆∞·ªùi d√πng mu·ªën B·∫¨T b·∫£o m·∫≠t 2 l·ªõp:
1. **Request**: User g·ª≠i request b·∫≠t 2FA
   ```
   PUT /api/users/{id}/security/password-change-2fa?enable=true
   ```

2. **Token Generation**: H·ªá th·ªëng t·∫°o token v√† l∆∞u v√†o DB
   - Token c√≥ th·ªùi h·∫°n 30 ph√∫t
   - L∆∞u tr·∫°ng th√°i `enable_2fa = true`

3. **Email G·ª≠i**: Email x√°c nh·∫≠n ƒë∆∞·ª£c g·ª≠i t·ªõi user
   - Ch·ªß ƒë·ªÅ: "üîí X√°c nh·∫≠n b·∫≠t b·∫£o m·∫≠t 2 l·ªõp"
   - M√†u xanh l√°, bi·ªÉu t∆∞·ª£ng kh√≥a
   - C√≥ h·ªôp th√¥ng tin gi·∫£i th√≠ch l·ª£i √≠ch c·ªßa 2FA

4. **X√°c nh·∫≠n**: User click link trong email
   ```
   POST /api/auth/security/2fa-toggle/confirm?token={TOKEN}
   ```

5. **K√≠ch ho·∫°t**: H·ªá th·ªëng c·∫≠p nh·∫≠t `requireEmailVerificationForPasswordChange = true`

### Khi ng∆∞·ªùi d√πng mu·ªën T·∫ÆT b·∫£o m·∫≠t 2 l·ªõp:
1. **Request**: User g·ª≠i request t·∫Øt 2FA
   ```
   PUT /api/users/{id}/security/password-change-2fa?enable=false
   ```

2. **Token Generation**: H·ªá th·ªëng t·∫°o token v√† l∆∞u v√†o DB
   - Token c√≥ th·ªùi h·∫°n 30 ph√∫t
   - L∆∞u tr·∫°ng th√°i `enable_2fa = false`

3. **Email G·ª≠i**: Email c·∫£nh b√°o ƒë∆∞·ª£c g·ª≠i t·ªõi user
   - Ch·ªß ƒë·ªÅ: "‚ö° X√°c nh·∫≠n t·∫Øt b·∫£o m·∫≠t 2 l·ªõp"
   - M√†u cam, bi·ªÉu t∆∞·ª£ng tia ch·ªõp
   - C√≥ h·ªôp c·∫£nh b√°o v·ªÅ vi·ªác gi·∫£m b·∫£o m·∫≠t

4. **X√°c nh·∫≠n**: User click link trong email
   ```
   POST /api/auth/security/2fa-toggle/confirm?token={TOKEN}
   ```

5. **V√¥ hi·ªáu h√≥a**: H·ªá th·ªëng c·∫≠p nh·∫≠t `requireEmailVerificationForPasswordChange = false`

## üóÇÔ∏è C·∫•u tr√∫c Code

### 1. Entity: `PasswordChange2FAToken.java`
```java
@Entity
@Table(name = "password_change_2fa_tokens")
public class PasswordChange2FAToken {
    private Long id;
    private String token;        // UUID
    private User user;           // FK -> users
    private boolean enable2FA;   // true = b·∫≠t, false = t·∫Øt
    private LocalDateTime expiryDate;
    private boolean isUsed;
    private LocalDateTime createdAt;
}
```

**Validation Methods:**
- `isExpired()`: Ki·ªÉm tra token ƒë√£ h·∫øt h·∫°n ch∆∞a
- `isValid()`: Ki·ªÉm tra token c√≤n h·ª£p l·ªá kh√¥ng (ch∆∞a h·∫øt h·∫°n v√† ch∆∞a d√πng)

### 2. Repository: `PasswordChange2FATokenRepository.java`
```java
public interface PasswordChange2FATokenRepository extends JpaRepository<...> {
    Optional<PasswordChange2FAToken> findByToken(String token);
    void deleteByExpiryDateBefore(LocalDateTime dateTime);
    void deleteByUser(User user);
}
```

### 3. Service: `PasswordChange2FAService.java`
**Main Methods:**

#### a. `request2FAToggle(userId, enable)`
- T√¨m user theo ID
- Ki·ªÉm tra n·∫øu ƒë√£ ·ªü tr·∫°ng th√°i y√™u c·∫ßu ‚Üí throw exception
- X√≥a token c≈© c·ªßa user (n·∫øu c√≥)
- T·∫°o token m·ªõi v·ªõi th·ªùi h·∫°n 30 ph√∫t
- G·ª≠i email x√°c nh·∫≠n
- Return void

#### b. `validate2FAToggleToken(token)`
- T√¨m token trong DB
- Ki·ªÉm tra token c√≥ t·ªìn t·∫°i kh√¥ng
- Ki·ªÉm tra token c√≤n valid kh√¥ng (ch∆∞a h·∫øt h·∫°n, ch∆∞a d√πng)
- Return boolean

#### c. `confirm2FAToggle(token)`
- Validate token (throw exception n·∫øu invalid)
- L·∫•y th√¥ng tin user v√† enable2FA t·ª´ token
- C·∫≠p nh·∫≠t `user.requireEmailVerificationForPasswordChange = enable2FA`
- ƒê√°nh d·∫•u token ƒë√£ s·ª≠ d·ª•ng (`isUsed = true`)
- L∆∞u v√†o DB
- Return void

#### d. `cleanupExpiredTokens()`
- X√≥a t·∫•t c·∫£ token ƒë√£ h·∫øt h·∫°n
- N√™n ch·∫°y ƒë·ªãnh k·ª≥ (scheduled task)

### 4. Controller: `PasswordChange2FAController.java`
**Public Endpoints** (kh√¥ng c·∫ßn JWT authentication):

#### a. `GET /api/auth/security/2fa-toggle/validate?token={token}`
```json
// Success response
{
  "message": "Token h·ª£p l·ªá",
  "success": true
}

// Error response
{
  "message": "Token kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ h·∫øt h·∫°n",
  "success": false
}
```

#### b. `POST /api/auth/security/2fa-toggle/confirm?token={token}`
```json
// Success response
{
  "message": "C√†i ƒë·∫∑t b·∫£o m·∫≠t 2 l·ªõp ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t th√†nh c√¥ng",
  "success": true
}
```

### 5. UserController Update
**Protected Endpoint** (c·∫ßn JWT authentication):

#### `PUT /api/users/{id}/security/password-change-2fa?enable={true|false}`
```java
// OLD logic (instant toggle):
userService.togglePasswordChangeEmailVerification(id, enable);

// NEW logic (send email confirmation):
passwordChange2FAService.request2FAToggle(id, enable);

// Response message:
"Email x√°c nh·∫≠n ƒë√£ ƒë∆∞·ª£c g·ª≠i. Vui l√≤ng ki·ªÉm tra h·ªôp th∆∞ ƒë·ªÉ ho√†n t·∫•t vi·ªác b·∫≠t/t·∫Øt b·∫£o m·∫≠t 2 l·ªõp."
```

### 6. Email Template: `EmailService.java`
**Method**: `send2FAToggleConfirmationEmail(toEmail, token, enable)`

**Khi B·∫¨T 2FA** (`enable = true`):
- üé® M√†u xanh l√° (#27ae60)
- üîí Icon kh√≥a
- üì¶ Info Box: Gi·∫£i th√≠ch l·ª£i √≠ch c·ªßa 2FA
- üîó Button: "X√°c nh·∫≠n b·∫≠t b·∫£o m·∫≠t 2 l·ªõp"

**Khi T·∫ÆT 2FA** (`enable = false`):
- üé® M√†u cam (#e67e22)
- ‚ö° Icon tia ch·ªõp
- ‚ö†Ô∏è Warning Box: C·∫£nh b√°o gi·∫£m b·∫£o m·∫≠t
- üîó Button: "X√°c nh·∫≠n t·∫Øt b·∫£o m·∫≠t 2 l·ªõp"

## üíæ Database Migration

### V5__Add_Password_Change_2FA_Tokens.sql
```sql
CREATE TABLE password_change_2fa_tokens (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    token VARCHAR(255) NOT NULL UNIQUE,
    user_id BIGINT NOT NULL,
    enable_2fa BOOLEAN NOT NULL,
    expiry_date DATETIME NOT NULL,
    is_used BOOLEAN DEFAULT FALSE,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT fk_2fa_token_user 
        FOREIGN KEY (user_id) REFERENCES users(id) 
        ON DELETE CASCADE,
    
    INDEX idx_token (token),
    INDEX idx_user_id (user_id),
    INDEX idx_expiry (expiry_date)
);
```

## üîí Security Features

### 1. Token Security
- ‚úÖ UUID random token (kh√¥ng ƒëo√°n ƒë∆∞·ª£c)
- ‚úÖ Th·ªùi h·∫°n 30 ph√∫t
- ‚úÖ One-time use (ƒë√°nh d·∫•u `isUsed` sau khi d√πng)
- ‚úÖ T·ª± ƒë·ªông cleanup tokens h·∫øt h·∫°n

### 2. Access Control
- ‚úÖ Toggle endpoint: C·∫ßn JWT + (ADMIN role ho·∫∑c ch√≠nh user ƒë√≥)
- ‚úÖ Confirm endpoint: Public (x√°c th·ª±c qua token trong email)

### 3. Business Logic Validation
- ‚úÖ Ki·ªÉm tra n·∫øu ƒë√£ ·ªü tr·∫°ng th√°i y√™u c·∫ßu
- ‚úÖ X√≥a token c≈© tr∆∞·ªõc khi t·∫°o token m·ªõi
- ‚úÖ Validate token tr∆∞·ªõc khi confirm

### 4. User Experience
- ‚úÖ Email templates kh√°c nhau cho b·∫≠t/t·∫Øt
- ‚úÖ Th√¥ng b√°o r√µ r√†ng v·ªÅ h√†nh ƒë·ªông
- ‚úÖ H∆∞·ªõng d·∫´n v√† gi·∫£i th√≠ch trong email

## üß™ Testing Flow

### Test Case 1: B·∫≠t 2FA th√†nh c√¥ng
```bash
# Step 1: Request b·∫≠t 2FA (c·∫ßn JWT token)
PUT http://localhost:8080/api/users/1/security/password-change-2fa?enable=true
Authorization: Bearer {JWT_TOKEN}

# Expected: 200 OK
# Response: "Email x√°c nh·∫≠n ƒë√£ ƒë∆∞·ª£c g·ª≠i..."

# Step 2: Ki·ªÉm tra email inbox
# Expected: Email v·ªõi subject "üîí X√°c nh·∫≠n b·∫≠t b·∫£o m·∫≠t 2 l·ªõp"

# Step 3: Validate token (optional)
GET http://localhost:8080/api/auth/security/2fa-toggle/validate?token={TOKEN}

# Expected: 200 OK
# Response: "Token h·ª£p l·ªá"

# Step 4: Confirm
POST http://localhost:8080/api/auth/security/2fa-toggle/confirm?token={TOKEN}

# Expected: 200 OK
# Response: "C√†i ƒë·∫∑t b·∫£o m·∫≠t 2 l·ªõp ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t th√†nh c√¥ng"

# Step 5: Verify in database
SELECT require_email_verification_for_password_change FROM users WHERE id = 1;
# Expected: TRUE
```

### Test Case 2: T·∫Øt 2FA th√†nh c√¥ng
```bash
# Step 1: Request t·∫Øt 2FA
PUT http://localhost:8080/api/users/1/security/password-change-2fa?enable=false
Authorization: Bearer {JWT_TOKEN}

# Step 2: Check email
# Expected: Email v·ªõi subject "‚ö° X√°c nh·∫≠n t·∫Øt b·∫£o m·∫≠t 2 l·ªõp"

# Step 3: Confirm
POST http://localhost:8080/api/auth/security/2fa-toggle/confirm?token={TOKEN}

# Step 4: Verify
SELECT require_email_verification_for_password_change FROM users WHERE id = 1;
# Expected: FALSE
```

### Test Case 3: Token h·∫øt h·∫°n
```bash
# Step 1: Request b·∫≠t 2FA
PUT http://localhost:8080/api/users/1/security/password-change-2fa?enable=true

# Step 2: ƒê·ª£i > 30 ph√∫t

# Step 3: Confirm v·ªõi token c≈©
POST http://localhost:8080/api/auth/security/2fa-toggle/confirm?token={EXPIRED_TOKEN}

# Expected: 400 BAD REQUEST
# Response: "Token kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ h·∫øt h·∫°n"
```

### Test Case 4: Token ƒë√£ s·ª≠ d·ª•ng
```bash
# Step 1: Request v√† confirm th√†nh c√¥ng
# Step 2: Th·ª≠ confirm l·∫°i v·ªõi c√πng token
POST http://localhost:8080/api/auth/security/2fa-toggle/confirm?token={USED_TOKEN}

# Expected: 400 BAD REQUEST
```

### Test Case 5: Request tr√πng tr·∫°ng th√°i
```bash
# Gi·∫£ s·ª≠ user ƒë√£ b·∫≠t 2FA

# Step 1: Request b·∫≠t 2FA l·∫°i
PUT http://localhost:8080/api/users/1/security/password-change-2fa?enable=true

# Expected: 400 BAD REQUEST
# Response: "B·∫£o m·∫≠t 2 l·ªõp ƒë√£ ƒë∆∞·ª£c b·∫≠t r·ªìi"
```

## üìä Error Handling

### Exception Messages
```java
// Trong PasswordChange2FAService

// Case 1: User kh√¥ng t·ªìn t·∫°i
throw new ResourceNotFoundException("User", "id", userId);

// Case 2: ƒê√£ ·ªü tr·∫°ng th√°i y√™u c·∫ßu
if (user.isRequireEmailVerificationForPasswordChange() == enable) {
    throw new IllegalStateException(
        enable 
            ? "B·∫£o m·∫≠t 2 l·ªõp ƒë√£ ƒë∆∞·ª£c b·∫≠t r·ªìi"
            : "B·∫£o m·∫≠t 2 l·ªõp ƒë√£ ƒë∆∞·ª£c t·∫Øt r·ªìi"
    );
}

// Case 3: Token kh√¥ng h·ª£p l·ªá
throw new IllegalArgumentException("Token kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ h·∫øt h·∫°n");
```

## üîÑ T√≠ch h·ª£p v·ªõi c√°c t√≠nh nƒÉng kh√°c

### 1. Password Change Flow
Sau khi user b·∫≠t/t·∫Øt 2FA, vi·ªác ƒë·ªïi m·∫≠t kh·∫©u s·∫Ω theo logic:

**Khi 2FA B·∫¨T** (`requireEmailVerificationForPasswordChange = true`):
```
User ƒë·ªïi password ‚Üí G·ª≠i email x√°c nh·∫≠n ‚Üí User click link ‚Üí Password ƒë∆∞·ª£c ƒë·ªïi
```

**Khi 2FA T·∫ÆT** (`requireEmailVerificationForPasswordChange = false`):
```
User ƒë·ªïi password ‚Üí Ki·ªÉm tra password c≈© ‚Üí Password ƒë∆∞·ª£c ƒë·ªïi ngay
```

### 2. User Profile Response
```json
{
  "id": 1,
  "username": "john_doe",
  "email": "john@example.com",
  "requireEmailVerificationForPasswordChange": true,  // Hi·ªÉn th·ªã tr·∫°ng th√°i 2FA
  ...
}
```

## üìù Notes

### Maintenance Tasks
1. **Cleanup expired tokens**: N√™n t·∫°o scheduled task ch·∫°y m·ªói ng√†y
   ```java
   @Scheduled(cron = "0 0 0 * * *") // Ch·∫°y l√∫c 0h m·ªói ng√†y
   public void cleanupExpiredTokens() {
       passwordChange2FAService.cleanupExpiredTokens();
   }
   ```

2. **Monitor token usage**: Log khi token ƒë∆∞·ª£c t·∫°o v√† s·ª≠ d·ª•ng
   ```java
   log.info("2FA toggle token created for user: {}, enable: {}", userId, enable);
   log.info("2FA toggle confirmed for user: {}, enable: {}", userId, enable);
   ```

### Future Enhancements
- [ ] Th√™m rate limiting cho vi·ªác request token (tr√°nh spam)
- [ ] Log audit trail cho m·ªçi thay ƒë·ªïi 2FA setting
- [ ] Th√¥ng b√°o khi c√≥ ng∆∞·ªùi c·ªë thay ƒë·ªïi 2FA (failed attempts)
- [ ] Option ƒë·ªÉ y√™u c·∫ßu x√°c nh·∫≠n password hi·ªán t·∫°i tr∆∞·ªõc khi g·ª≠i email

## üéØ Summary

### Created Files:
1. `PasswordChange2FAToken.java` - Entity
2. `PasswordChange2FATokenRepository.java` - Repository
3. `PasswordChange2FAService.java` - Service (4 methods)
4. `PasswordChange2FAController.java` - Controller (2 endpoints)
5. `V5__Add_Password_Change_2FA_Tokens.sql` - Migration

### Updated Files:
1. `UserController.java` - Thay ƒë·ªïi logic toggle endpoint
2. `EmailService.java` - Th√™m method v√† template

### API Endpoints:
1. `PUT /api/users/{id}/security/password-change-2fa?enable={bool}` - Protected
2. `GET /api/auth/security/2fa-toggle/validate?token={token}` - Public
3. `POST /api/auth/security/2fa-toggle/confirm?token={token}` - Public

### Database Changes:
- B·∫£ng m·ªõi: `password_change_2fa_tokens`
- 3 indexes: token, user_id, expiry_date
- Foreign key: user_id ‚Üí users(id)
