# üìò Soft Delete API Usage Examples

## üéØ M·ª•c ƒë√≠ch

Document n√†y h∆∞·ªõng d·∫´n c√°ch s·ª≠ d·ª•ng c√°c endpoints soft delete trong th·ª±c t·∫ø.

## üì¶ Prerequisites

- Spring Boot application ƒë√£ ch·∫°y t·∫°i `localhost:8080`
- Database ƒë√£ c√≥ seed data
- Tool test API: Postman, curl, ho·∫∑c Thunder Client

---

## üß™ Test Flow: T·ª´ X√≥a ƒë·∫øn Kh√¥i ph·ª•c

### B∆∞·ªõc 1: T·∫°o User m·ªõi (Setup)

```bash
POST http://localhost:8080/api/users
Content-Type: application/json

{
  "fullName": "Test User",
  "email": "test@washify.com",
  "password": "123456",
  "phone": "0901234567",
  "address": "123 Test Street"
}
```

**Response:**
```json
{
  "success": true,
  "message": "User created successfully",
  "data": {
    "id": 10,
    "fullName": "Test User",
    "email": "test@washify.com"
  }
}
```

---

### B∆∞·ªõc 2: X√≥a m·ªÅm User

```bash
DELETE http://localhost:8080/api/users/10
```

**ƒêi·ªÅu g√¨ x·∫£y ra:**
- ‚úÖ User kh√¥ng b·ªã x√≥a v·∫≠t l√Ω kh·ªèi database
- ‚úÖ Column `deleted_at` ƒë∆∞·ª£c set = NOW()
- ‚úÖ User kh√¥ng c√≤n hi·ªán trong danh s√°ch users th√¥ng th∆∞·ªùng
- ‚úÖ Relationships v·∫´n c√≤n nguy√™n (orders, reviews c·ªßa user n√†y v·∫´n t·ªìn t·∫°i)

**SQL th·ª±c thi:**
```sql
-- Thay v√¨: DELETE FROM users WHERE id = 10
-- Hibernate ch·∫°y:
UPDATE users SET deleted_at = NOW() WHERE id = 10
```

---

### B∆∞·ªõc 3: Verify User ƒë√£ b·ªã ·∫©n

```bash
GET http://localhost:8080/api/users
```

**Response:** User ID 10 kh√¥ng c√≤n trong danh s√°ch

```json
{
  "success": true,
  "data": [
    { "id": 1, "fullName": "Admin User" },
    { "id": 2, "fullName": "Customer 1" }
    // User 10 kh√¥ng c√≥ ·ªü ƒë√¢y
  ]
}
```

---

### B∆∞·ªõc 4: Xem danh s√°ch Users ƒë√£ x√≥a

```bash
GET http://localhost:8080/api/soft-delete/users/deleted
```

**Response:**
```json
{
  "success": true,
  "message": "L·∫•y danh s√°ch users ƒë√£ x√≥a th√†nh c√¥ng",
  "data": [
    {
      "id": 10,
      "fullName": "Test User",
      "email": "test@washify.com",
      "deletedAt": "2024-01-15T14:30:00"
    }
  ],
  "timestamp": "2024-01-15T15:00:00"
}
```

---

### B∆∞·ªõc 5: Kh√¥i ph·ª•c User

```bash
PUT http://localhost:8080/api/soft-delete/users/10/restore
```

**Response:**
```json
{
  "success": true,
  "message": "User ƒë√£ ƒë∆∞·ª£c kh√¥i ph·ª•c th√†nh c√¥ng",
  "data": null,
  "timestamp": "2024-01-15T15:05:00"
}
```

**SQL th·ª±c thi:**
```sql
UPDATE users SET deleted_at = NULL WHERE id = 10
```

---

### B∆∞·ªõc 6: Verify User ƒë√£ ƒë∆∞·ª£c kh√¥i ph·ª•c

```bash
GET http://localhost:8080/api/users
```

**Response:** User 10 ƒë√£ tr·ªü l·∫°i danh s√°ch

```json
{
  "success": true,
  "data": [
    { "id": 1, "fullName": "Admin User" },
    { "id": 2, "fullName": "Customer 1" },
    { "id": 10, "fullName": "Test User" }  // ‚úÖ ƒê√£ quay l·∫°i!
  ]
}
```

---

## üî• X√≥a Vƒ©nh Vi·ªÖn (Permanent Delete)

### ‚ö†Ô∏è C·∫¢NH B√ÅO

X√≥a vƒ©nh vi·ªÖn s·∫Ω:
- ‚ùå X√≥a ho√†n to√†n record kh·ªèi database
- ‚ùå KH√îNG TH·ªÇ kh√¥i ph·ª•c
- ‚ùå C√≥ th·ªÉ g√¢y l·ªói foreign key n·∫øu c√≥ relationships

**Ch·ªâ d√πng khi:**
- Tu√¢n th·ªß GDPR (x√≥a d·ªØ li·ªáu c√° nh√¢n theo y√™u c·∫ßu)
- D·ªçn d·∫πp test data
- Ch·∫Øc ch·∫Øn 100% kh√¥ng c·∫ßn data n√†y

### C√°ch s·ª≠ d·ª•ng:

```bash
DELETE http://localhost:8080/api/soft-delete/users/10/permanent
```

**Response:**
```json
{
  "success": true,
  "message": "User ƒë√£ ƒë∆∞·ª£c x√≥a vƒ©nh vi·ªÖn",
  "data": null
}
```

**SQL th·ª±c thi:**
```sql
DELETE FROM users WHERE id = 10  -- X√≥a th·∫≠t s·ª±!
```

---

## üì¶ C√°c Entities kh√°c

### Branch Example

```bash
# Xem branches ƒë√£ x√≥a
GET http://localhost:8080/api/soft-delete/branches/deleted

# Kh√¥i ph·ª•c branch
PUT http://localhost:8080/api/soft-delete/branches/5/restore

# X√≥a vƒ©nh vi·ªÖn
DELETE http://localhost:8080/api/soft-delete/branches/5/permanent
```

### Service Example

```bash
# Xem services ƒë√£ x√≥a
GET http://localhost:8080/api/soft-delete/services/deleted

# Kh√¥i ph·ª•c service
PUT http://localhost:8080/api/soft-delete/services/3/restore
```

### Order Example

```bash
# Xem orders ƒë√£ x√≥a
GET http://localhost:8080/api/soft-delete/orders/deleted

# Kh√¥i ph·ª•c order
PUT http://localhost:8080/api/soft-delete/orders/100/restore
```

### Promotion Example

```bash
# Xem promotions ƒë√£ x√≥a
GET http://localhost:8080/api/soft-delete/promotions/deleted

# Kh√¥i ph·ª•c promotion
PUT http://localhost:8080/api/soft-delete/promotions/2/restore
```

### Shipper Example

```bash
# Xem shippers ƒë√£ x√≥a
GET http://localhost:8080/api/soft-delete/shippers/deleted

# Kh√¥i ph·ª•c shipper
PUT http://localhost:8080/api/soft-delete/shippers/7/restore
```

---

## üß© Integration v·ªõi Frontend

### React Example

```javascript
// X√≥a m·ªÅm user
const softDeleteUser = async (userId) => {
  await axios.delete(`/api/users/${userId}`);
  toast.success('User ƒë√£ ƒë∆∞·ª£c x√≥a');
};

// Xem users ƒë√£ x√≥a
const getDeletedUsers = async () => {
  const response = await axios.get('/api/soft-delete/users/deleted');
  return response.data.data;
};

// Kh√¥i ph·ª•c user
const restoreUser = async (userId) => {
  await axios.put(`/api/soft-delete/users/${userId}/restore`);
  toast.success('User ƒë√£ ƒë∆∞·ª£c kh√¥i ph·ª•c');
};

// X√≥a vƒ©nh vi·ªÖn (v·ªõi confirm dialog)
const permanentDeleteUser = async (userId) => {
  if (confirm('C·∫¢NH B√ÅO: B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a vƒ©nh vi·ªÖn? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!')) {
    await axios.delete(`/api/soft-delete/users/${userId}/permanent`);
    toast.warning('User ƒë√£ b·ªã x√≥a vƒ©nh vi·ªÖn');
  }
};
```

### Admin UI Component

```jsx
function DeletedUsersManager() {
  const [deletedUsers, setDeletedUsers] = useState([]);
  
  useEffect(() => {
    fetchDeletedUsers();
  }, []);
  
  const fetchDeletedUsers = async () => {
    const response = await axios.get('/api/soft-delete/users/deleted');
    setDeletedUsers(response.data.data);
  };
  
  const handleRestore = async (userId) => {
    await axios.put(`/api/soft-delete/users/${userId}/restore`);
    fetchDeletedUsers(); // Refresh list
    toast.success('ƒê√£ kh√¥i ph·ª•c user');
  };
  
  return (
    <div className="deleted-users">
      <h2>üóëÔ∏è Users ƒë√£ x√≥a</h2>
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>T√™n</th>
            <th>Email</th>
            <th>X√≥a l√∫c</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {deletedUsers.map(user => (
            <tr key={user.id}>
              <td>{user.id}</td>
              <td>{user.fullName}</td>
              <td>{user.email}</td>
              <td>{new Date(user.deletedAt).toLocaleString()}</td>
              <td>
                <button onClick={() => handleRestore(user.id)}>
                  ‚ôªÔ∏è Kh√¥i ph·ª•c
                </button>
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  );
}
```

---

## üîç Database Queries ƒë·ªÉ Debug

### Xem t·∫•t c·∫£ users (c·∫£ ƒë√£ x√≥a)

```sql
SELECT id, full_name, email, deleted_at, is_active
FROM users
ORDER BY deleted_at DESC;
```

### ƒê·∫øm users active vs deleted

```sql
SELECT 
  COUNT(*) as total,
  SUM(CASE WHEN deleted_at IS NULL THEN 1 ELSE 0 END) as active,
  SUM(CASE WHEN deleted_at IS NOT NULL THEN 1 ELSE 0 END) as deleted
FROM users;
```

### Xem users x√≥a trong 7 ng√†y g·∫ßn ƒë√¢y

```sql
SELECT id, full_name, email, deleted_at
FROM users
WHERE deleted_at >= DATE_SUB(NOW(), INTERVAL 7 DAY)
ORDER BY deleted_at DESC;
```

### Manual restore (n·∫øu c·∫ßn)

```sql
UPDATE users 
SET deleted_at = NULL 
WHERE id = 10;
```

### Manual soft delete (n·∫øu c·∫ßn)

```sql
UPDATE users 
SET deleted_at = NOW() 
WHERE id = 10;
```

---

## ‚úÖ Best Practices

### 1. Quy·ªÅn Truy C·∫≠p

```java
// Ch·ªâ ADMIN ƒë∆∞·ª£c xem deleted records
@PreAuthorize("hasRole('ADMIN')")
@GetMapping("/api/soft-delete/users/deleted")
public ResponseEntity<?> getDeletedUsers() {
    // ...
}
```

### 2. Audit Log

```java
// Log m·ªçi h√†nh ƒë·ªông restore/permanent delete
@PutMapping("/users/{id}/restore")
public ResponseEntity<?> restoreUser(@PathVariable Long id) {
    auditService.log("RESTORE_USER", id, getCurrentUser());
    boolean restored = softDeleteService.restoreUser(id);
    // ...
}
```

### 3. Confirmation Dialog

```javascript
// Frontend PH·∫¢I confirm tr∆∞·ªõc khi permanent delete
const permanentDelete = (id) => {
  Swal.fire({
    title: '‚ö†Ô∏è C·∫¢NH B√ÅO',
    text: 'X√≥a vƒ©nh vi·ªÖn kh√¥ng th·ªÉ ho√†n t√°c. B·∫°n ch·∫Øc ch·∫Øn?',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: 'X√≥a vƒ©nh vi·ªÖn',
    cancelButtonText: 'H·ªßy'
  }).then((result) => {
    if (result.isConfirmed) {
      axios.delete(`/api/soft-delete/users/${id}/permanent`);
    }
  });
};
```

### 4. Auto-Cleanup Policy

```java
// Scheduled job: X√≥a vƒ©nh vi·ªÖn records ƒë√£ x√≥a m·ªÅm > 30 ng√†y
@Scheduled(cron = "0 0 2 * * ?") // 2AM m·ªói ng√†y
public void cleanupOldDeletedRecords() {
    LocalDateTime cutoff = LocalDateTime.now().minusDays(30);
    userRepository.permanentlyDeleteOlderThan(cutoff);
}
```

---

## üêõ Troubleshooting

### Issue: "Kh√¥ng th·ªÉ kh√¥i ph·ª•c user"

**Nguy√™n nh√¢n:**
- User ID kh√¥ng t·ªìn t·∫°i
- User ch∆∞a b·ªã x√≥a m·ªÅm (deleted_at = NULL)

**Gi·∫£i ph√°p:**
```bash
# Check user status
GET /api/soft-delete/users/deleted

# Verify ID c√≥ trong danh s√°ch kh√¥ng
```

### Issue: Foreign Key Error khi permanent delete

**Nguy√™n nh√¢n:**
- User c√≤n relationships (orders, reviews, etc.)

**Gi·∫£i ph√°p:**
```java
// Soft delete thay v√¨ permanent delete
// HO·∫∂C x√≥a cascade relationships tr∆∞·ªõc
```

---

## üìä Metrics & Monitoring

### Track Soft Delete Operations

```java
// Prometheus metrics
@Timed(value = "soft_delete.restore", description = "Time to restore entity")
public boolean restoreUser(Long id) {
    // ...
}

@Counted(value = "soft_delete.permanent_delete", description = "Count of permanent deletes")
public boolean permanentlyDeleteUser(Long id) {
    // ...
}
```

### Dashboard Queries

```sql
-- Deleted users per day (last 30 days)
SELECT DATE(deleted_at) as date, COUNT(*) as count
FROM users
WHERE deleted_at >= DATE_SUB(NOW(), INTERVAL 30 DAY)
GROUP BY DATE(deleted_at)
ORDER BY date DESC;

-- Restore rate
SELECT 
  (SELECT COUNT(*) FROM users WHERE deleted_at IS NOT NULL) as currently_deleted,
  (SELECT COUNT(*) FROM audit_log WHERE action = 'RESTORE_USER') as total_restores;
```

---

## üéì Summary

**Soft Delete Flow:**
```
User exists ‚Üí DELETE call ‚Üí deleted_at set ‚Üí Hidden from queries
‚Üí Can view in /deleted ‚Üí Can restore ‚Üí deleted_at = NULL ‚Üí Back to normal
‚Üí OR permanent delete ‚Üí Gone forever ‚ùå
```

**Key Endpoints:**
- `GET /api/soft-delete/{entity}/deleted` - Xem ƒë√£ x√≥a
- `PUT /api/soft-delete/{entity}/{id}/restore` - Kh√¥i ph·ª•c
- `DELETE /api/soft-delete/{entity}/{id}/permanent` - X√≥a vƒ©nh vi·ªÖn

**Remember:**
- ‚úÖ Soft delete = Safe, reversible
- ‚ö†Ô∏è Permanent delete = Dangerous, irreversible
- üîí Only admins should access soft delete endpoints
- üìù Always log restore/permanent delete actions
