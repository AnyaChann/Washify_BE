package com.washify.apis.controller;

import com.washify.apis.dto.request.ShipmentRequest;
import com.washify.apis.dto.response.ApiResponse;
import com.washify.apis.dto.response.ShipmentResponse;
import com.washify.apis.service.ShipmentService;
import jakarta.validation.Valid;
import lombok.RequiredArgsConstructor;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.*;

import java.util.List;

/**
 * REST Controller x·ª≠ l√Ω c√°c API li√™n quan ƒë·∫øn Shipment
 */
@RestController
@RequestMapping("/shipments")
@RequiredArgsConstructor
@io.swagger.v3.oas.annotations.tags.Tag(name = "üöö Shipments", description = "Qu·∫£n l√Ω v·∫≠n chuy·ªÉn - üöö Shipper/Staff/Admin")
public class ShipmentController {
    
    private final ShipmentService shipmentService;
    
    /**
     * T·∫°o giao h√†ng m·ªõi
     * POST /api/shipments
     * Ch·ªâ Staff v√† Admin
     */
    @PostMapping
    @PreAuthorize("hasAnyRole('STAFF', 'ADMIN')")
    public ResponseEntity<ApiResponse<ShipmentResponse>> createShipment(@Valid @RequestBody ShipmentRequest request) {
        ShipmentResponse shipment = shipmentService.createShipment(request);
        return ResponseEntity.status(HttpStatus.CREATED)
                .body(ApiResponse.success(shipment, "T·∫°o giao h√†ng th√†nh c√¥ng"));
    }
    
    /**
     * L·∫•y th√¥ng tin giao h√†ng theo ID
     * GET /api/shipments/{id}
     * Staff/Admin xem t·∫•t c·∫£, Shipper xem c·ªßa m√¨nh
     */
    @GetMapping("/{id}")
    @PreAuthorize("hasAnyRole('ADMIN', 'STAFF', 'SHIPPER')")
    public ResponseEntity<ApiResponse<ShipmentResponse>> getShipmentById(@PathVariable Long id) {
        ShipmentResponse shipment = shipmentService.getShipmentById(id);
        return ResponseEntity.ok(ApiResponse.success(shipment, "L·∫•y th√¥ng tin giao h√†ng th√†nh c√¥ng"));
    }
    
    /**
     * L·∫•y giao h√†ng theo order ID
     * GET /api/shipments/order/{orderId}
     * Staff/Admin/Shipper c√≥ th·ªÉ xem
     */
    @GetMapping("/order/{orderId}")
    @PreAuthorize("hasAnyRole('ADMIN', 'STAFF', 'SHIPPER')")
    public ResponseEntity<ApiResponse<ShipmentResponse>> getShipmentByOrderId(@PathVariable Long orderId) {
        ShipmentResponse shipment = shipmentService.getShipmentByOrderId(orderId);
        return ResponseEntity.ok(ApiResponse.success(shipment, "L·∫•y th√¥ng tin giao h√†ng th√†nh c√¥ng"));
    }
    
    /**
     * L·∫•y danh s√°ch giao h√†ng c·ªßa shipper
     * GET /api/shipments/shipper/{shipperId}
     * Admin/Staff xem t·∫•t c·∫£, Shipper xem c·ªßa m√¨nh
     */
    @GetMapping("/shipper/{shipperId}")
    @PreAuthorize("hasAnyRole('ADMIN', 'STAFF') or #shipperId == authentication.principal.id")
    public ResponseEntity<ApiResponse<List<ShipmentResponse>>> getShipmentsByShipperId(@PathVariable Long shipperId) {
        List<ShipmentResponse> shipments = shipmentService.getShipmentsByShipperId(shipperId);
        return ResponseEntity.ok(ApiResponse.success(shipments, "L·∫•y danh s√°ch giao h√†ng th√†nh c√¥ng"));
    }
    
    /**
     * L·∫•y danh s√°ch giao h√†ng theo tr·∫°ng th√°i
     * GET /api/shipments/status/{status}
     * Ch·ªâ Admin v√† Staff
     */
    @GetMapping("/status/{status}")
    @PreAuthorize("hasAnyRole('ADMIN', 'STAFF')")
    public ResponseEntity<ApiResponse<List<ShipmentResponse>>> getShipmentsByStatus(@PathVariable String status) {
        List<ShipmentResponse> shipments = shipmentService.getShipmentsByStatus(status);
        return ResponseEntity.ok(ApiResponse.success(shipments, "L·∫•y danh s√°ch giao h√†ng th√†nh c√¥ng"));
    }
    
    /**
     * C·∫≠p nh·∫≠t tr·∫°ng th√°i giao h√†ng
     * PATCH /api/shipments/{id}/status
     * Shipper c·∫≠p nh·∫≠t ƒë∆°n c·ªßa m√¨nh, Staff/Admin c·∫≠p nh·∫≠t t·∫•t c·∫£
     */
    @PatchMapping("/{id}/status")
    @PreAuthorize("hasAnyRole('SHIPPER', 'STAFF', 'ADMIN')")
    public ResponseEntity<ApiResponse<ShipmentResponse>> updateShipmentStatus(
            @PathVariable Long id,
            @RequestParam String status) {
        ShipmentResponse shipment = shipmentService.updateShipmentStatus(id, status);
        return ResponseEntity.ok(ApiResponse.success(shipment, "C·∫≠p nh·∫≠t tr·∫°ng th√°i giao h√†ng th√†nh c√¥ng"));
    }
    
    /**
     * G√°n shipper cho ƒë∆°n giao h√†ng
     * PATCH /api/shipments/{id}/assign-shipper
     * Ch·ªâ Staff v√† Admin
     */
    @PatchMapping("/{id}/assign-shipper")
    @PreAuthorize("hasAnyRole('STAFF', 'ADMIN')")
    public ResponseEntity<ApiResponse<ShipmentResponse>> assignShipper(
            @PathVariable Long id,
            @RequestParam Long shipperId) {
        ShipmentResponse shipment = shipmentService.assignShipper(id, shipperId);
        return ResponseEntity.ok(ApiResponse.success(shipment, "G√°n shipper th√†nh c√¥ng"));
    }
}
